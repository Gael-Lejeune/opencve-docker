import openpyxl
from pathlib import Path
from opencve.commands.add_product_to_client import add_product_to_client
import click
from flask import current_app as app
from flask.cli import with_appcontext
from sqlalchemy.exc import IntegrityError
from opencve.commands import ensure_config, error, info

from opencve.extensions import db
from opencve.models.clients import Client
from opencve.models.products import Product
from opencve.models.vendors import Vendor


def add_product(client,vendor,product):
    """Add Product to client"""
    client_query=Client.query.filter_by(name=client).first().id
    if not client_query:
        return info(f"{client} does not exists in Clients")
    vendor_query=Vendor.query.filter_by(name=vendor).first().id
    if not vendor_query:
        return info(f"{vendor} does not exists in Vendors")
    product_query=Product.query.filter_by(name=product,vendor_id=vendor_query).first().id
    if not product_query:
        return info(f"{product} does not exists in Products")
    #FOR TESTING ONLY, NEED TO CHECK THE INPUT OR CHANGE THE USED METHOD //TODO
    existance=db.session.execute("SELECT 1 FROM clients_products WHERE client_id=('"+str(client_query)+"') and product_id=('"+str(product_query)+"')").first()
    if existance:
        return info(f"{product} already exists in client {client}")
    db.session.execute("INSERT INTO clients_products(client_id,product_id) VALUES (('"+str(client_query)+"'),('"+str(product_query)+"'))")
    try:   
        db.session.commit()
    except IntegrityError as e:
        error(e)
    else:
        return info("Product "+str(product)+" added to client "+str(client))



@click.command()
@click.argument("client")
@click.argument("file_path")
@with_appcontext
def read_excel(client,file_path):
	xlsx_file = Path(file_path)
	wb_obj = openpyxl.load_workbook(xlsx_file) 
	sheet = wb_obj.active	
	l = sheet.max_row	
	data=[]
	for i in range(3,l):
		if sheet["G"+str(i)].value!=None:
			d=str(sheet["C"+str(i)].value).lower()+":"+str(sheet["G"+str(i)].value).lower()
			if d not in data:
				data.append(d)	
	for i in data:
		add_product(client,i.split(":")[0],i.split(":")[1])
import datetime

import click
from flask import current_app as app
from flask.cli import with_appcontext
from sqlalchemy.exc import IntegrityError

from opencve.commands import ensure_config, error, info
from opencve.extensions import db
from opencve.models.clients import Client
from opencve.models.users import User


@click.command()
@click.argument("name")
@click.argument("user")


@with_appcontext
def create_client(name, user):
    """Create a user or admin."""
    if Client.query.filter_by(name=name).first():
        raise click.BadParameter(f"{name} already exists.", param_hint="name")

    client = Client(
        name=name,
    )
    db.session.add(client)
    userquery= User.query.filter_by(username=user).first()
    userquery.clients+=name #Not tested
    try:
        db.session.commit()
    except IntegrityError as e:
        error(e)
    else:
        info("Client {} created.".format(client))
